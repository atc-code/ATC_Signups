<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ATC Monthly Signups</title>
<style>
  :root{--max:980px;--pad:18px;--radius:16px;--accent:#2b6cb0}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f7fb;color:#111827}
  header{background:#1f2937;color:#fff;padding:28px var(--pad)}
  .hdr{max-width:var(--max);margin:0 auto;display:grid;grid-template-columns:64px 1fr;gap:14px;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:#fff;padding:8px;box-shadow:0 6px 18px rgba(0,0,0,.18)}
  .title{text-align:center}
  .title h1{margin:0;font-weight:800;font-size:clamp(1.4rem,3.4vw,2rem)}
  .title p{margin:6px 0 0;opacity:.95;font-style:italic}
  main{max-width:var(--max);margin:18px auto;padding:0 var(--pad);display:grid;gap:16px}
  .card{background:#fff;border-radius:var(--radius);box-shadow:0 6px 22px rgba(0,0,0,.08);padding:18px}
  fieldset{border:0;margin:0 0 12px;padding:0}
  legend{font-weight:800;margin-bottom:8px}
  label{font-weight:600;display:block;margin:6px 0}
  input[type="text"],input[type="email"],input[type="month"],textarea{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:820px){.grid2{grid-template-columns:1fr}.hdr{grid-template-columns:48px 1fr}.logo{width:48px;height:48px}}
  .teams{display:grid;grid-template-columns:1fr 1fr;gap:10px 16px}
  @media (max-width:720px){.teams{grid-template-columns:1fr}}
  .team{display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px}
  .muted{color:#6b7280}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
  .primary{background:var(--accent);color:#fff}
  .secondary{background:#eef2f7}
  .msg{display:none;margin-top:12px;padding:12px 14px;border-radius:12px}
  .ok{background:#e6fffa;border:1px solid #b2f5ea;color:#065f46}
  .err{background:#fff5f5;border:1px solid #fecaca;color:#7f1d1d}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px}
  footer{padding:10px 0 24px;text-align:center;color:#6b7280}
</style>
</head>
<body>
<header>
  <div class="hdr">
    <img class="logo" src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="ATC"/>
    <div class="title">
      <h1>ATC Monthly Signups</h1>
      <p>Colossians 3:23–24 — “Whatever you do, work at it with all your heart… it is the Lord Christ you are serving.”</p>
    </div>
  </div>
</header>

<main>
  <!-- Month + Sundays info -->
  <section class="card">
    <fieldset>
      <legend style="font-size:1.05rem">Service Month<span style="color:#b91c1c;margin-left:6px">*</span></legend>
      <div class="grid2">
        <div>
          <label for="month" style="font-size:1.05rem">Select Month</label>
          <input type="month" id="month">
        </div>
        <div>
          <label>Remaining Sundays (for info)</label>
          <div id="sundays" class="chips"><span class="muted">Select a month…</span></div>
        </div>
      </div>
    </fieldset>
  </section>

  <!-- Signup form -->
  <section class="card">
    <form id="f" autocomplete="on">
      <fieldset>
        <legend>Choose your team(s)<span style="color:#b91c1c;margin-left:6px">*</span></legend>
        <div id="roles" class="teams"><div class="muted">Pick a month to load roles…</div></div>
        <div class="muted" style="margin-top:6px">Full roles are hidden automatically.</div>
      </fieldset>

      <fieldset>
        <legend>Contact information</legend>
        <div class="grid2">
          <div>
            <label for="first">First Name<span style="color:#b91c1c">*</span></label>
            <input id="first" type="text" required minlength="4" placeholder="e.g., John">
          </div>
          <div>
            <label for="last">Last Name<span style="color:#b91c1c">*</span></label>
            <input id="last" type="text" required minlength="4" placeholder="e.g., Doe">
          </div>
        </div>
        <div class="grid2">
          <div>
            <label for="email">Email<span style="color:#b91c1c">*</span></label>
            <input id="email" type="email" required placeholder="name@example.com">
          </div>
          <div>
            <label for="phone">Phone<span style="color:#b91c1c">*</span></label>
            <input id="phone" type="text" inputmode="tel" required placeholder="(###) ###-####">
          </div>
        </div>
        <div>
          <label for="notes">Comments / Notes</label>
          <textarea id="notes" placeholder="Any preferences or dates you can’t make…"></textarea>
        </div>
      </fieldset>

      <div class="actions">
        <button type="submit" id="submit" class="primary">Submit</button>
        <button type="reset" class="secondary">Clear</button>
      </div>
      <div id="ok" class="msg ok">Thank you! Your monthly signup was recorded. A confirmation email is on its way.</div>
      <div id="err" class="msg err">Sorry, something went wrong.</div>
    </form>
  </section>

  <!-- Roster (bottom) -->
  <section class="card">
    <h2 style="margin:0 0 10px">Current Signups</h2>
    <div id="rosterWrap" class="chips"><span class="muted">No signups yet.</span></div>
  </section>
</main>

<footer>© ATC</footer>

<script>
  // === CONFIG ===
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbxm8ojZW3cMZS_CWtJo-CdLY5Ph2zm3d7pooGWovtlxYkqrNaj4ih_ru5bhrEoCgL7k/exec";

  // === HELPERS ===
  const $ = (id)=>document.getElementById(id);

  function jsonp(url){
    return new Promise((res, rej)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const s  = document.createElement('script');
      const q  = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      window[cb] = (data)=>{ delete window[cb]; s.remove(); res(data); };
      s.onerror = ()=>{ delete window[cb]; s.remove(); rej(new Error('Network/JSONP error')); };
      s.src = q;
      document.body.appendChild(s);
    });
  }

  function setDefaultMonth(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    $('month').value = y + '-' + m;
  }

  function phoneMask(el){
    let v = el.value.replace(/\D/g,'').slice(0,10);
    let o = '';
    if (v.length>0) o = '(' + v.substring(0, Math.min(3,v.length));
    if (v.length>=4) o += ') ' + v.substring(3, Math.min(6,v.length));
    if (v.length>=7) o += '-' + v.substring(6, 10);
    el.value = o || v;
  }

  function renderSundays(cal){
    const box = $('sundays'); box.innerHTML = '';
    if (!cal || !cal.length){ box.innerHTML = '<span class="muted">No Sundays found.</span>'; return; }
    cal.forEach(d=>{
      // Pretty like “November 21, 2025”
      const pretty = new Date(d.ServiceDate + 'T00:00:00').toLocaleDateString(undefined, {year:'numeric',month:'long',day:'numeric'});
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = pretty;
      box.appendChild(span);
    });
  }

  function renderRoles(roles, remaining){
    const wrap = $('roles'); wrap.innerHTML = '';
    if (!roles || !roles.length){ wrap.innerHTML = '<div class="muted">No roles configured.</div>'; return; }
    roles.forEach(r=>{
      const role = r.role;
      const left = (remaining && remaining.hasOwnProperty(role)) ? remaining[role] : null;
      // hide if full
      if (left !== null && left <= 0) return;
      const label = document.createElement('label');
      label.className = 'team';
      label.innerHTML = `<input type="checkbox" name="role" value="${role.replace(/"/g,'&quot;')}"> <span>${role}</span>`;
      wrap.appendChild(label);
    });
    if (!wrap.children.length){
      wrap.innerHTML = '<div class="muted">All roles are full for this month.</div>';
    }
  }

  function renderRoster(roster){
    const wrap = $('rosterWrap'); wrap.innerHTML = '';
    const roles = Object.keys(roster||{});
    if (!roles.length){ wrap.innerHTML = '<span class="muted">No signups yet.</span>'; return; }
    roles.forEach(role=>{
      const names = roster[role] || [];
      if (!names.length) return;
      const row = document.createElement('div');
      row.style.display='block';
      row.style.margin='6px 0';
      const title = document.createElement('div');
      title.style.fontWeight='700';
      title.textContent = role;
      const chips = document.createElement('div');
      chips.className = 'chips';
      names.forEach(n=>{
        const c = document.createElement('span');
        c.className = 'chip';
        c.textContent = n;
        chips.appendChild(c);
      });
      row.appendChild(title);
      row.appendChild(chips);
      wrap.appendChild(row);
    });
  }

  async function refreshForMonth(){
    const month = $('month').value;
    if (!month){
      $('sundays').innerHTML = '<span class="muted">Select a month…</span>';
      $('roles').innerHTML = '<div class="muted">Pick a month to load roles…</div>';
      $('rosterWrap').innerHTML = '<span class="muted">No signups yet.</span>';
      return;
    }

    try{
      // Sundays info (display only)
      const calResp = await jsonp(`${ENDPOINT}?mode=calendar&month=${encodeURIComponent(month)}`);
      renderSundays((calResp && calResp.cal) || []);

      // Roles & remaining (hide full)
      const rr = await jsonp(`${ENDPOINT}?mode=roles_remaining&month=${encodeURIComponent(month)}`);
      renderRoles((rr && rr.roles)||[], (rr && rr.remaining)||{});

      // Roster
      const ro = await jsonp(`${ENDPOINT}?mode=roster_month&month=${encodeURIComponent(month)}`);
      renderRoster(ro && ro.roster);
    }catch(e){
      console.error(e);
      $('roles').innerHTML = '<div class="muted">Failed to load. Try again.</div>';
    }
  }

  // === INIT ===
  window.addEventListener('load', ()=>{
    setDefaultMonth();
    refreshForMonth();
    $('month').addEventListener('change', refreshForMonth);
    $('phone').addEventListener('input', ()=> phoneMask($('phone')));

    $('f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const month = $('month').value;
      const roles = [...document.querySelectorAll('input[name="role"]:checked')].map(x=>x.value);
      const first = $('first').value.trim();
      const last  = $('last').value.trim();
      const email = $('email').value.trim();
      const phone = $('phone').value.trim();
      const comments = $('notes').value.trim();

      if (!month || !roles.length || first.length<4 || last.length<4 || !email || !phone){
        $('err').textContent = 'Please complete all required fields.';
        $('err').style.display = 'block';
        $('ok').style.display = 'none';
        return;
      }

      $('submit').disabled = true; $('err').style.display='none'; $('ok').style.display='none';
      try{
        const url = `${ENDPOINT}?mode=submit_get`
          + `&month=${encodeURIComponent(month)}`
          + `&roles=${encodeURIComponent(roles.join(','))}`
          + `&firstName=${encodeURIComponent(first)}`
          + `&lastName=${encodeURIComponent(last)}`
          + `&email=${encodeURIComponent(email)}`
          + `&phone=${encodeURIComponent(phone)}`
          + `&comments=${encodeURIComponent(comments)}`;
        const out = await jsonp(url);
        if (out && out.ok){
          $('ok').style.display='block';
          $('f').reset();
          // Keep selected month; just refresh roles/roster
          await refreshForMonth();
        }else{
          throw new Error((out && out.error) || 'Submission failed.');
        }
      }catch(err){
        $('err').textContent = err.message || 'Submission failed.';
        $('err').style.display = 'block';
      }finally{
        $('submit').disabled = false;
      }
    });
  });
</script>
</body>
</html>
