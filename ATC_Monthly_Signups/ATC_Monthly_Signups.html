<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATC Monthly Signups</title>
  <style>
    :root { --max: 960px; --pad: 18px; --radius: 16px; --accent:#2b6cb0; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f7f7fb; color:#1a202c; }

    /* Header */
    header { background: #222; color: #fff; padding: 24px var(--pad); }
    .brandRow { position: relative; min-height: 104px; display: grid; grid-template-columns: 88px 1fr; gap: 12px; align-items: center; }
    .logo { height:88px;width:88px;border-radius:12px;background:#fff;padding:10px; box-shadow: 0 6px 20px rgba(0,0,0,.18);}
    header h1 { margin: 0 0 8px; font-size: clamp(1.6rem, 3.2vw, 2.2rem); line-height: 1.25; text-align:center; }
    header p  { margin: 0; opacity: .95; font-size: clamp(1rem, 2.2vw, 1.15rem); font-style: italic; text-align:center; }

    main { max-width: var(--max); margin: 20px auto; padding: 0 var(--pad); display:grid; gap:16px; }
    .card { background: #fff; border-radius: var(--radius); box-shadow: 0 6px 24px rgba(0,0,0,.08); padding: 18px; }

    fieldset { border: 0; padding: 0; margin: 0 0 12px; }
    legend { font-weight:800; margin-bottom: 10px; padding: 0; }
    label { font-weight: 800; display:block; margin-bottom: 6px; }
    label[for="month"] { font-size: 1.15rem; }
    input[type="text"], input[type="email"], textarea, input[type="month"], select {
      width: 100%; padding: 12px 14px; border: 1px solid #d9dbe3; border-radius: 10px; font-size: 1.05rem; background:#fff;
    }
    input[type="checkbox"] { width: 18px; height: 18px; }
    textarea { min-height: 90px; resize: vertical; }

    .actions { display:flex; gap: 10px; align-items: center; margin-top: 16px; flex-wrap:wrap; }
    button { border: 0; padding: 12px 16px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size:1rem; }
    .primary { background: var(--accent); color: #fff; }
    .secondary { background: #edf2f7; }
    .msg { margin-top: 14px; padding: 12px 14px; border-radius: 10px; display: none; }
    .success { background: #e6fffa; border: 1px solid #b2f5ea; color: #234e52; }
    .error { background: #fff5f5; border: 1px solid #fed7d7; color: #742a2a; }

    .muted { color:#666; }

    /* Month grid & Sunday cards */
    .monthGrid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 860px){ .monthGrid { grid-template-columns:1fr; } header .brandRow { grid-template-columns: 64px 1fr; } .logo{ height:64px; width:64px; } }
    #monthGrid .muted { text-align:center; }
    .sundayCard { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:12px; }
    .sundayHead { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .roleList { display:grid; grid-template-columns: 1fr; gap:8px; }
    .roleItem { display:flex; align-items:center; gap:10px; }
    .roleLeft { color:#64748b; font-size:.95rem; min-width: 160px; }
    .badge { font-size:.82rem; border:1px solid #e2e8f0; border-radius:999px; padding:2px 8px; }
    .chip { display:inline-block; margin:4px 6px 0 0; padding:4px 8px; border:1px solid #e2e8f0; border-radius:999px; font-size:.95rem; }

    footer { text-align:center; color:#374151; padding: 16px; }

    /* Sign-in overlay (Google Identity Services) */
    .overlay { position:fixed; inset:0; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; padding:24px; z-index:1000; }
    .overlay .inner { max-width:600px; text-align:center; }
    .overlay p{ opacity:.9; }
    .err{margin-top:10px;background:#7f1d1d;color:#fff;border-radius:10px;padding:8px 10px;font-size:.95rem;display:none}
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- Sign-in overlay -->
  <div id="signinOverlay" class="overlay" style="display:none">
    <div class="inner">
      <div class="brandRow" style="justify-content:center;margin-bottom:8px;">
        <img src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="Church Logo" class="logo" />
        <div>
          <h2 style="margin:0">Sign in to Volunteer at ATC</h2>
          <p>Your Google sign-in confirms your signup and prevents duplicates.</p>
        </div>
      </div>
      <div id="gSignIn" style="display:inline-block;"></div>
      <div id="signinError" class="err"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" style="display:none">
    <header>
      <div class="brandRow">
        <img src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="Church Logo" class="logo" />
        <div>
          <h1>ATC Monthly Signups</h1>
          <p>Colossians 3:23–24 — “Whatever you do, work at it with all your heart… it is the Lord Christ you are serving.”</p>
        </div>
      </div>
    </header>

    <main>
      <!-- Form -->
      <section class="card" id="formCard">
        <form id="f" autocomplete="on">
          <fieldset>
            <legend>Service</legend>
            <div>
              <label for="month">Service Month<span class="req">*</span></label>
              <input type="month" id="month">
              <div class="muted" style="margin-top:6px">Select a month to load Sundays (and Men’s Fellowship if scheduled).</div>
            </div>
          </fieldset>

          <!-- Sundays + roles will render here -->
          <section class="card" id="monthGridCard" style="margin-top:10px;">
            <h2 style="margin-top:0;">Select Sundays & Roles</h2>
            <div id="monthGrid" class="monthGrid">
              <div class="muted">Select a month to load Sundays…</div>
            </div>
          </section>

          <fieldset id="contactFS" style="margin-top:14px">
            <legend>Contact information</legend>
            <div class="grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div>
                <label for="first">First Name<span class="req">*</span></label>
                <input id="first" type="text" required minlength="4" pattern="[A-Za-z][A-Za-z\s\-']{3,}" placeholder="e.g., John">
              </div>
              <div>
                <label for="last">Last Name<span class="req">*</span></label>
                <input id="last" type="text" required minlength="4" pattern="[A-Za-z][A-Za-z\s\-']{3,}" placeholder="e.g., Doe">
              </div>
            </div>
            <div class="grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div>
                <label for="email">Email<span class="req">*</span></label>
                <input id="email" type="email" required placeholder="name@example.com">
              </div>
              <div>
                <label for="phone">Phone<span class="req">*</span></label>
                <input id="phone" type="text" inputmode="tel" required placeholder="(###) ###-####">
              </div>
            </div>
            <div>
              <label for="notes">Comments / Notes</label>
              <textarea id="notes" placeholder="Any preferences or availability details…"></textarea>
            </div>
          </fieldset>

          <div class="actions" id="actionsRow">
      <button class="primary" type="submit" id="submit">Submit</button>
      <button class="secondary" type="reset">Clear</button>
    </div>
    <div id="ok" class="msg success">Thank you! Your signup was recorded.</div>
    <div id="err" class="msg error">Sorry, something went wrong.</div>
  </form>
</section>

      <!-- Admin metrics -->
      <section class="card" id="adminCard" style="display:none">
        <h2 style="margin-top:0">Admin — Activity Metrics</h2>
        <div class="tableWrap">
          <table class="metrics">
            <thead><tr><th>Email</th><th>Views</th><th>Submits</th></tr></thead>
            <tbody id="metrics"><tr><td colspan="3" class="muted">No data.</td></tr></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer></footer>
  </div>

  <script>
    // === Config ===
    const GOOGLE_CLIENT_ID = "180743986209-prt051o1bp6namb57ababodokq0eadfv.apps.googleusercontent.com";
    const ADMIN_EMAILS = ["atc.noting@gmail.com","chakdom@gmail.com"];
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzeMYO7V9OX7iBFzuRtfbMXrk9CzP0xArxeB0hOOdXZjdklGtOBlTjeLpYDFOrGQsHk/exec"; // e.g., https://script.google.com/macros/s/AKfy.../exec

    // === State ===
    let ID_TOKEN = '';
    const MonthState = { dates: [], byDate: {} }; // dates are ISO strings

    // JSONP helper (single definition)
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s  = document.createElement('script');
        const to = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, 12000);
        function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
        s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
        document.head.appendChild(s);
      });
    }

    // Google Identity Services
    function initGIS(){
      const overlay = document.getElementById('signinOverlay');
      overlay.style.display = 'flex';
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp) => {
          try{
            if(!resp || !resp.credential) throw new Error('No credential returned.');
            ID_TOKEN = resp.credential;
            localStorage.setItem('atc_id_token', ID_TOKEN);
            localStorage.setItem('atc_id_token_time', Date.now().toString());
            overlay.style.display='none';
            document.getElementById('app').style.display='block';
            initAfterSignIn();
          }catch(e){
            const el = document.getElementById('signinError');
            el.textContent = e.message || 'Sign-in failed. Please try again.';
            el.style.display = 'block';
          }
        },
        auto_select: false,
        ux_mode: 'popup'
      });
      google.accounts.id.renderButton(
        document.getElementById('gSignIn'),
        { theme: "outline", size: "large", text: "signin_with", shape: "pill" }
      );
    }

    // Helpers
    const $ = (id)=>document.getElementById(id);
    function phoneMask(el){
      let v = el.value.replace(/\D/g,'').slice(0,10);
      const p=[]; if(v.length>0) p.push('(' + v.substring(0,Math.min(3,v.length)));
      if(v.length>=4) p[0]+=') ' + v.substring(3,Math.min(6,v.length));
      if(v.length>=7) p[0]+='-' + v.substring(6,10);
      el.value = p[0] || v;
    }
    function fmtLongDate(iso){ const [y,m,d] = iso.split('-').map(Number); const dt = new Date(y,m-1,d); return dt.toLocaleDateString(undefined,{month:'long',day:'numeric',year:'numeric'}); }

    // Month loader
    async function loadDates(){
  const month = $('month').value;
  const grid  = $('monthGrid');

  // Always show the form card (so month picker is visible)
  $('formCard').style.display = 'block';

  // Hide everything else until a month is chosen
  if (!month) {
    $('monthGridCard').style.display = 'none';
    $('contactFS').style.display     = 'none';
    $('actionsRow').style.display    = 'none';
    grid.innerHTML = '<div class="muted">Select a month to load Sundays…</div>';
    return;
  }

  // Month chosen → show grid; we'll show contact+buttons after data loads
  $('monthGridCard').style.display = 'block';
  $('contactFS').style.display     = 'none';
  $('actionsRow').style.display    = 'none';

  grid.innerHTML = '<div class="muted">Loading…</div>';

  try {
    const url = `${ENDPOINT}?mode=calendar&month=${encodeURIComponent(month)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
    const res = await jsonp(url);
    const cal = Array.isArray(res?.cal) ? res.cal : [];

    // Split Sundays vs Men’s Fellowship
    const titleHasMF = d => /men'?s\s+fellowship/i.test(String(d.Title||'').trim());
    const sundays = cal.filter(d => isSundayISO(String(d.ServiceDate).trim()) && !titleHasMF(d));
    const mensF   = cal.find(d => titleHasMF(d));


    renderMonthGrid(sundays);

    if (mensF){
      const id = `mf_${mensF.ServiceDate}`;
      grid.insertAdjacentHTML('beforeend', `
        <div class="sundayCard" id="${id}">
          <div class="sundayHead">
            <div><strong>${fmtLongDate(mensF.ServiceDate)}</strong> <span class="badge">Men’s Fellowship</span></div>
          </div>
          <div class="roleList" data-date="${mensF.ServiceDate}">
            <div class="muted">Loading roles…</div>
          </div>
          <div class="muted" style="margin-top:8px">Current Signups:</div>
          <div class="roleList rosterList" data-roster="${mensF.ServiceDate}">
            <div class="muted">Loading roster…</div>
          </div>
        </div>
      `);
      await loadRolesForDate(mensF.ServiceDate);
      await loadRosterForDate(mensF.ServiceDate);
    }

    // After we’ve rendered dates/roles successfully, show contact + buttons
    $('contactFS').style.display  = 'block';
    $('actionsRow').style.display = 'flex';

  } catch(e){
    console.error('loadDates error:', e);
    const el = $('signinError');
    el.textContent = (e && e.message) ? e.message : 'Failed to load Sundays.';
    el.style.display = 'block';
  }
}

    function renderMonthGrid(cal){
      const grid = $('monthGrid');
      grid.innerHTML = '';

      if (!cal || !cal.length){
        grid.innerHTML = '<div class="muted">No Sundays found for this month.</div>';
        MonthState.dates = [];
        return;
      }

      MonthState.dates = cal.map(d => d.ServiceDate); // ISO strings
      MonthState.byDate = {};

      for (const d of cal){
        const id = `day_${d.ServiceDate}`;
        grid.insertAdjacentHTML('beforeend', `
          <div class="sundayCard" id="${id}">
            <div class="sundayHead">
              <div><strong>${fmtLongDate(d.ServiceDate)}</strong> <span class="badge">${d.Title || 'Service'}</span></div>
            </div>
            <div class="roleList" data-date="${d.ServiceDate}">
              <div class="muted">Loading roles…</div>
            </div>
            <div class="muted" style="margin-top:8px">Current Signups:</div>
            <div class="roleList rosterList" data-roster="${d.ServiceDate}">
              <div class="muted">Loading roster…</div>
            </div>
          </div>
        `);
      }

      for (const d of cal){
        loadRolesForDate(d.ServiceDate);
        loadRosterForDate(d.ServiceDate);
      }
    }

    async function loadRolesForDate(dateISO){
      try{
        const month = $('month').value;
        const url = `${ENDPOINT}?mode=roles&month=${encodeURIComponent(month)}&date=${encodeURIComponent(dateISO)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
        const { roles } = await jsonp(url);

        const list = document.querySelector(`.roleList[data-date="${dateISO}"]`);
        if (!list) return;

        if (!roles || !roles.length){
          list.innerHTML = '<div class="muted">No roles available for this date.</div>';
          return;
        }

        list.innerHTML = '';
        roles.forEach(r=>{
          list.insertAdjacentHTML('beforeend', `
            <label class="roleItem">
              <input type="checkbox" name="role-${dateISO}" value="${r.role.replace(/"/g,'&quot;')}">
              <span>${r.role}</span>
            </label>
          `);
        });
      }catch(e){
        const list = document.querySelector(`.roleList[data-date="${dateISO}"]`);
        if (list) list.innerHTML = `<div class="muted">Failed to load roles.</div>`;
        console.error('loadRolesForDate error:', e);
      }
    }

    async function loadRosterForDate(dateISO){
      try{
        const month = $('month').value;
        const url = `${ENDPOINT}?mode=roster&month=${encodeURIComponent(month)}&date=${encodeURIComponent(dateISO)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
        const roster = await jsonp(url); // { role: [names] }
        const area = document.querySelector(`.rosterList[data-roster="${dateISO}"]`);
        if (!area) return;

        const roles = Object.keys(roster || {});
        if (!roles.length) {
          area.innerHTML = '<div class="muted">No signups yet.</div>';
          return;
        }

        const rows = roles.map(role=>{
          const names = (roster[role]||[]).map(n=>`<span class="chip">${n}</span>`).join(' ');
          return `<div class="roleItem"><div class="roleLeft">${role}</div><div>${names || '<span class="muted">—</span>'}</div></div>`;
        }).join('');
        area.innerHTML = rows;

      }catch(e){
        const area = document.querySelector(`.rosterList[data-roster="${dateISO}"]`);
        if (area) area.innerHTML = '<div class="muted">Failed to load roster.</div>';
        console.error('loadRosterForDate error:', e);
      }
    }

    function collectMonthSelections(){
      const picks = []; // [{ date:'yyyy-MM-dd', roles:[...] }]
      for (const date of MonthState.dates){
        const selected = [...document.querySelectorAll(`input[name="role-${date}"]:checked`)].map(x=>x.value);
        if (selected.length) picks.push({ date, roles: selected });
      }
      return picks;
    }

    async function loadMetrics(){
      try{
        const url = `${ENDPOINT}?mode=metrics&id_token=${encodeURIComponent(ID_TOKEN)}`;
        const rows = await jsonp(url);
        const tb = $('metrics'); tb.innerHTML='';
        if(!rows || !rows.length){ tb.innerHTML='<tr><td colspan="3" class="muted">No data.</td></tr>'; return; }
        rows.forEach(r=>{
          tb.insertAdjacentHTML('beforeend','<tr><td>'+r.email+'</td><td>'+r.views+'</td><td>'+r.submits+'</td></tr>');
        });
      }catch(_){}
    }

    async function initAfterSignIn(){
  try{ jsonp(`${ENDPOINT}?mode=view_ping&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`).catch(()=>{}); }catch(_){}

  $('app').style.display='block';
  $('phone').addEventListener('input', ()=> phoneMask($('phone')));
  $('month').addEventListener('change', loadDates);

  // Show the form card with only the month picker visible on first load
  $('formCard').style.display   = 'block';
  $('monthGridCard').style.display = 'none';
  $('contactFS').style.display  = 'none';
  $('actionsRow').style.display = 'none';
}


    // Boot: reuse sign-in for 1 hour if available
    window.addEventListener('load', () => {
      const cachedToken = localStorage.getItem('atc_id_token');
      const cachedTime  = parseInt(localStorage.getItem('atc_id_token_time') || '0', 10);
      const now = Date.now();
      if (cachedToken && (now - cachedTime < 3600 * 1000)) {
        ID_TOKEN = cachedToken;
        document.getElementById('signinOverlay').style.display='none';
        document.getElementById('app').style.display='block';
        initAfterSignIn();
      } else {
        initGIS();
      }
    });
  </script>
</body>
</html>
