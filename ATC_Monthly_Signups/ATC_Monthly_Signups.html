<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ATC Monthly Signups</title>
<style>
:root{ --max:1060px; --pad:18px; --radius:16px; --accent:#1e3a8a; }
*{ box-sizing:border-box; }
body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; color:#0f172a; }

/* Header */
.header{
  background:#152233; color:#fff; padding:22px var(--pad);
}
.header-inner{
  max-width:var(--max); margin:0 auto; display:flex; align-items:center; gap:18px;
}
.header-title{ flex:1; text-align:center; }
.header-title h1{ margin:0 0 6px; font-size:clamp(1.6rem,3.2vw,2.3rem); }
.header-title p{ margin:0; opacity:.95; font-style:italic; font-size:clamp(.95rem,2.4vw,1.05rem);}
.header-logo{ width:78px; height:78px; border-radius:14px; background:#fff; padding:10px; box-shadow:0 8px 26px rgba(0,0,0,.22); }
.header-right{ display:flex; align-items:center; justify-content:flex-end; width:92px; }

/* Layout */
main{ max-width:var(--max); margin:22px auto; padding:0 var(--pad); display:grid; gap:16px; }
.card{ background:#fff; border-radius:var(--radius); box-shadow:0 10px 28px rgba(2,6,23,.08); padding:18px; }
.section-title{ font-size:1.25rem; font-weight:800; margin:0 0 14px; }

/* Month row */
.month-grid{
  display:grid; grid-template-columns:1fr 300px; gap:18px;
}
@media (max-width:940px){ .month-grid{ grid-template-columns:1fr; } }

label{ font-weight:700; display:block; margin:0 0 8px; }
input[type="month"], input[type="text"], input[type="email"], textarea{
  width:100%; padding:12px 14px; border:1px solid #e2e8f0; border-radius:12px; font-size:1rem; background:#fff;
}
.badge-col{ display:flex; flex-direction:column; gap:10px; }
.badge{ display:inline-block; padding:8px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc; font-size:.95rem; white-space:nowrap; }

/* Two-column main form */
.form-grid{
  display:grid; grid-template-columns: 0.7fr 1fr; gap:18px;
}
@media (max-width:1000px){ .form-grid{ grid-template-columns:1fr; } }

/* Teams list – single column */
.team-list{ display:flex; flex-direction:column; gap:12px; }
.team{
  display:flex; align-items:center; gap:10px; border:1px solid #e2e8f0; border-radius:12px; padding:12px 14px;
}

/* Buttons & messages */
.actions{ display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap; }
button{ border:0; padding:12px 16px; border-radius:12px; font-weight:800; cursor:pointer; }
.btn-primary{ background:var(--accent); color:#fff; }
.btn-secondary{ background:#e5e7eb; }
.msg{ display:none; margin-top:10px; border-radius:10px; padding:12px 14px; }
.msg.ok{ background:#ecfeff; color:#0c4a6e; border:1px solid #a5f3fc; }
.msg.err{ background:#fff5f5; color:#7f1d1d; border:1px solid #fecaca; }

/* Roster table */
.table-wrap{ overflow:auto; }
table{ width:100%; border-collapse:collapse; }
th,td{ text-align:left; border-bottom:1px solid #e5e7eb; padding:10px 8px; }
th{ color:#334155; font-size:.97rem; }

/* Footer (improved) */
.site-footer{ background:#0f172a; color:#cbd5e1; margin-top:8px; }
.site-footer .foot-inner{ max-width:var(--max); margin:0 auto; padding:14px var(--pad); text-align:center; font-size:.95rem; }
.site-footer a{ color:#e2e8f0; text-decoration:underline; } .site-footer a:hover{ text-decoration:none; }
</style>
<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxm8ojZW3cMZS_CWtJo-CdLY5Ph2zm3d7pooGWovtlxYkqrNaj4ih_ru5bhrEoCgL7k/exec";

// Simple JSONP helper (avoids CORS)
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const cleanup=()=>{ delete window[cb]; s.remove(); };
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('Network error')); };
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    document.head.appendChild(s);
  });
}

const $ = sel => document.querySelector(sel);

// Persist month across refreshes
function saveMonth(m){ try{ localStorage.setItem('atc_month', m); }catch(e){} }
function loadSavedMonth(){ try{ return localStorage.getItem('atc_month')||''; }catch(e){ return '';} }

function isoMonthToday(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

let SUNDAYS = [];   // remaining Sundays for selected month (info-only)
let ROLES   = [];   // [{role, limit}]
let REM     = {};   // {role: remaining}

// Enable/disable submit depending on Sundays remaining
function updateSubmitState(){
  const btn = $('#submitBtn');
  const warn = $('#noSundaysWarn');
  const has = (SUNDAYS && SUNDAYS.length>0);
  if (has){
    btn.disabled = false;
    warn.style.display = 'none';
  }else{
    btn.disabled = true;
    warn.style.display = 'block';
  }
}

// Render “Remaining Sundays” (info-only), hide past dates automatically (backend already filters, but keep safe)
function renderSundays(){
  const col = $('#sundaysCol'); col.innerHTML = '';
  if (!SUNDAYS || !SUNDAYS.length){
    col.innerHTML = '<span class="badge">No Sundays remaining</span>';
    return;
  }
  SUNDAYS.forEach(s => {
    const el = document.createElement('span');
    el.className = 'badge';
    // Pretty date
    const d = new Date(s.ServiceDate+'T00:00:00');
    const pretty = d.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
    el.textContent = pretty;
    col.appendChild(el);
  });
}

// Render roles as single-column checklist
function renderRoles(){
  const wrap = $('#rolesWrap'); wrap.innerHTML = '';
  if (!ROLES || !ROLES.length){
    wrap.innerHTML = '<div class="badge" style="background:#fffbe6;border-color:#fde68a;">No roles configured.</div>';
    return;
  }
  ROLES.forEach(r=>{
    const left = (Number.isFinite(REM[r.role]) ? REM[r.role] : null);
    if (left !== null && left <= 0) return; // “Full roles are hidden automatically.”
    const id = 'role_' + r.role.replace(/\W+/g,'_');
    const row = document.createElement('label');
    row.className = 'team';
    row.innerHTML = `<input type="checkbox" id="${id}" name="role" value="${r.role}"> <span>${r.role}</span>`;
    wrap.appendChild(row);
  });
}

// Render roster (Current Signups) as table Role | Name | Notes
function renderRoster(map){
  const body = $('#rosterBody');
  body.innerHTML = '';
  const roles = Object.keys(map||{});
  if (!roles.length){
    body.innerHTML = '<tr><td colspan="3">No signups yet.</td></tr>';
    return;
  }
  roles.forEach(role=>{
    const list = map[role]||[];
    list.forEach((item, idx)=>{
      const tr = document.createElement('tr');
      const roleCell = (idx===0) ? `<td rowspan="${list.length}"><strong>${role}</strong></td>` : '';
      if (idx===0){
        tr.innerHTML = `${roleCell}<td>${item.name||'—'}</td><td>${item.comments||''}</td>`;
      }else{
        tr.innerHTML = `<td>${item.name||'—'}</td><td>${item.comments||''}</td>`;
      }
      body.appendChild(tr);
    });
  });
}

async function refreshAll(){
  const month = $('#month').value;
  if (!month) return;

  saveMonth(month);

  // 1) Sundays (info + submit gate)
  const cal = await jsonp(`${ENDPOINT}?mode=calendar&month=${encodeURIComponent(month)}`);
  SUNDAYS = (cal && cal.ok) ? (cal.cal||[]) : [];
  renderSundays();
  updateSubmitState();

  // 2) Roles + remaining counts
  const rr = await jsonp(`${ENDPOINT}?mode=roles&month=${encodeURIComponent(month)}`);
  if (rr && rr.ok){
    ROLES = rr.roles||[];
    REM   = rr.remaining||{};
    renderRoles();
  }else{
    ROLES = []; REM = {}; renderRoles();
  }

  // 3) Roster
  const ro = await jsonp(`${ENDPOINT}?mode=roster&month=${encodeURIComponent(month)}`);
  renderRoster((ro && ro.ok) ? (ro.roster||{}) : {});
}

function getChosenRoles(){
  return Array.from(document.querySelectorAll('input[name="role"]:checked')).map(x=>x.value);
}

function phoneMask(el){
  let v = el.value.replace(/\D/g,'').slice(0,10);
  let out = '';
  if (v.length>0) out = '('+v.slice(0,3);
  if (v.length>=4) out += ') '+v.slice(3,6);
  if (v.length>=7) out += '-'+v.slice(6);
  el.value = out;
}

async function onSubmit(e){
  e.preventDefault();
  const month = $('#month').value;
  const first = $('#first').value.trim();
  const last  = $('#last').value.trim();
  const email = $('#email').value.trim();
  const phone = $('#phone').value.trim();
  const comments = $('#notes').value.trim();
  const roles = getChosenRoles();
  const btn = $('#submitBtn');
  const OK = $('#ok'); const ERR = $('#err');

  OK.style.display='none'; ERR.style.display='none';

  if (!SUNDAYS || !SUNDAYS.length){
    ERR.textContent = 'Signups are closed for this month (no Sundays remaining).';
    ERR.style.display='block';
    return;
  }
  if (!month || !first || !last || !email || !roles.length){
    ERR.textContent = 'Please complete all required fields and select at least one team.';
    ERR.style.display='block';
    return;
  }

  btn.disabled = true;
  try{
    const url = `${ENDPOINT}?mode=submit_get`
      + `&month=${encodeURIComponent(month)}`
      + `&firstName=${encodeURIComponent(first)}`
      + `&lastName=${encodeURIComponent(last)}`
      + `&email=${encodeURIComponent(email)}`
      + `&phone=${encodeURIComponent(phone)}`
      + `&comments=${encodeURIComponent(comments)}`
      + `&roles=${encodeURIComponent(roles.join(','))}`;

    const out = await jsonp(url);
    if (out && out.ok){
      OK.textContent = 'Thank you! Your monthly signup was recorded.';
      OK.style.display='block';
      // Keep the month selection, but clear selections
      document.getElementById('f').reset();
      $('#month').value = month;
      await refreshAll();
    }else{
      throw new Error((out && out.error) || 'Submission failed.');
    }
  }catch(err){
    ERR.textContent = err.message || 'Submission failed.';
    ERR.style.display='block';
  }finally{
    btn.disabled = false;
  }
}

function boot(){
  // Header year in footer
  const fy = document.getElementById('foot-year');
  if (fy) fy.textContent = '© ' + new Date().getFullYear() + ' ';

  // Month default = last-selected or current
  const saved = loadSavedMonth();
  $('#month').value = saved || isoMonthToday();

  // Wire events
  $('#month').addEventListener('change', refreshAll);
  $('#phone').addEventListener('input', ()=>phoneMask($('#phone')));
  document.getElementById('f').addEventListener('submit', onSubmit);

  // Initial load
  refreshAll();
}
window.addEventListener('DOMContentLoaded', boot);
</script>
</head>
<body>

<!-- Header with logo on the RIGHT -->
<header class="header">
  <div class="header-inner">
    <div class="header-title">
      <h1>ATC Monthly Signups</h1>
      <p>Colossians 3:23–24 — “Whatever you do, work at it with all your heart… it is the Lord Christ you are serving.”</p>
    </div>
    <div class="header-right">
      <img class="header-logo" src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="ATC logo">
    </div>
  </div>
</header>

<main>
  <!-- Month & Sundays -->
  <section class="card">
    <div class="section-title">Service Month <span style="color:#b91c1c">*</span></div>
    <div class="month-grid">
      <div>
        <label for="month">Select Month</label>
        <input type="month" id="month">
      </div>
      <div>
        <label>Remaining Sundays (for info)</label>
        <div id="sundaysCol" class="badge-col"></div>
      </div>
    </div>
    <div id="noSundaysWarn" class="msg err" style="margin-top:12px;display:none">
      Signups are closed for this month (no Sundays remaining).
    </div>
  </section>

  <!-- Form: Teams + Contact -->
  <section class="card">
    <div class="form-grid">
      <div>
        <div class="section-title">Choose your team(s) <span style="color:#b91c1c">*</span></div>
        <div id="rolesWrap" class="team-list"></div>
      </div>

      <div>
        <div class="section-title">Contact information</div>
        <form id="f" autocomplete="on">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <label for="first">First Name <span style="color:#b91c1c">*</span></label>
              <input id="first" type="text" placeholder="e.g., John">
            </div>
            <div>
              <label for="last">Last Name <span style="color:#b91c1c">*</span></label>
              <input id="last" type="text" placeholder="e.g., Doe">
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
            <div>
              <label for="email">Email <span style="color:#b91c1c">*</span></label>
              <input id="email" type="email" placeholder="name@example.com">
            </div>
            <div>
              <label for="phone">Phone <span style="color:#b91c1c">*</span></label>
              <input id="phone" type="text" inputmode="tel" placeholder="(###) ###-####">
            </div>
          </div>
          <div style="margin-top:12px;">
            <label for="notes">Comments / Notes</label>
            <textarea id="notes" placeholder="Any preferences or dates you can’t make…"></textarea>
          </div>

          <div class="actions">
            <button id="submitBtn" class="btn-primary" type="submit">Submit</button>
            <button class="btn-secondary" type="reset">Clear</button>
          </div>
          <div id="ok" class="msg ok">Thank you! Your monthly signup was recorded.</div>
          <div id="err" class="msg err">Sorry, something went wrong.</div>
        </form>
      </div>
    </div>
  </section>

  <!-- Current Signups -->
  <section class="card">
    <div class="section-title">Current Signups</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Role</th><th>Name</th><th>Notes</th></tr></thead>
        <tbody id="rosterBody"><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="foot-inner">
    <span id="foot-year"></span>
    <a href="https://atlantateluguchurch.org/" target="_blank" rel="noopener">Atlanta Telugu Church</a> • All rights reserved
  </div>
</footer>

</body>
</html>
