<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATC Monthly Signups</title>
  <style>
    .monthGrid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
@media (max-width: 860px){ .monthGrid { grid-template-columns:1fr; } }
.sundayCard { border:1px solid #e2e8f0; border-radius:12px; padding:12px; }
.sundayHead { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.roleList { display:grid; grid-template-columns: 1fr; gap:8px; }
.roleItem { display:flex; align-items:center; gap:10px; }
.roleLeft { color:#64748b; font-size:.95rem; }
.badge { font-size:.82rem; border:1px solid #e2e8f0; border-radius:999px; padding:2px 8px; }

    :root { --max: 960px; --pad: 18px; --radius: 16px; --accent:#2b6cb0; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f7f7fb; color:#1a202c; }
    /* Header (Thanksgiving style) */
    header { background: #222; color: #fff; padding: 24px var(--pad); }
    .brandRow { position: relative; min-height: 104px; display: grid; grid-template-columns: 88px 1fr; gap: 12px; align-items: center; }
    .logo { height:88px;width:88px;border-radius:12px;background:#fff;padding:10px; box-shadow: 0 6px 20px rgba(0,0,0,.18);}
    header h1 { margin: 0 0 8px; font-size: clamp(1.6rem, 3.2vw, 2.2rem); line-height: 1.25; }
    header p  { margin: 0; opacity: .95; font-size: clamp(1rem, 2.2vw, 1.15rem); font-style: italic; }

    main { max-width: var(--max); margin: 20px auto; padding: 0 var(--pad); display:grid; gap:16px; }
    .card { background: #fff; border-radius: var(--radius); box-shadow: 0 6px 24px rgba(0,0,0,.08); padding: 18px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 860px){
      .grid-2{ grid-template-columns:1fr; }
      .brandRow{ grid-template-columns: 72px 1fr; min-height: 96px; }
      .logo{ height:64px; width:64px; }
      header h1{ font-size: clamp(1.3rem, 5vw, 1.9rem); }
    }

    fieldset { border: 0; padding: 0; margin: 0 0 12px; }
    legend { font-weight:800; margin-bottom: 10px; padding: 0; }
    label { font-weight: 600; display:block; margin-bottom: 6px; }
    input[type="text"], input[type="email"], textarea, input[type="month"], select {
      width: 100%; padding: 12px 14px; border: 1px solid #d9dbe3; border-radius: 10px; font-size: 1rem; background:#fff;
    }
    input[type="checkbox"] { width: 18px; height: 18px; }
    textarea { min-height: 90px; resize: vertical; }
    .teams { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 18px; margin-top: 4px; }
    @media (max-width: 720px) { .teams { grid-template-columns: 1fr; } }
    .team { display: flex; gap: 10px; align-items: center; padding: 10px 12px; border:1px solid #e2e8f0; border-radius: 12px; }
    .req { color: #c00; margin-left: 4px; }
    .actions { display:flex; gap: 10px; align-items: center; margin-top: 16px; flex-wrap:wrap; }
    button { border: 0; padding: 12px 16px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size:1rem; }
    .primary { background: var(--accent); color: #fff; }
    .secondary { background: #edf2f7; }
    .msg { margin-top: 14px; padding: 12px 14px; border-radius: 10px; display: none; }
    .success { background: #e6fffa; border: 1px solid #b2f5ea; color: #234e52; }
    .error { background: #fff5f5; border: 1px solid #fed7d7; color: #742a2a; }

    .muted { color:#666; }
    .tableWrap { overflow-x:auto; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; border-bottom:1px solid #e2e8f0; padding:10px 6px; vertical-align: top; }
    th { font-size:.95rem; color:#334155; }
    .chip { display:inline-block; margin:4px 6px 0 0; padding:4px 8px; border:1px solid #e2e8f0; border-radius:999px; font-size:.95rem; }

    footer { text-align:center; color:#374151; padding: 16px; }

    /* Sign-in overlay */
    .overlay { position:fixed; inset:0; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; padding:24px; z-index:1000; }
    .overlay .inner { max-width:600px; text-align:center; }
    .overlay p{ opacity:.9; }
    .err{margin-top:10px;background:#7f1d1d;color:#fff;border-radius:10px;padding:8px 10px;font-size:.95rem;display:none}
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- Sign-in overlay (GIS) -->
  <div id="signinOverlay" class="overlay" style="display:none">
    <div class="inner">
      <div class="brandRow" style="justify-content:center;margin-bottom:8px;">
        <img src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="Church Logo" class="logo" />
        <div>
          <h2 style="margin:0">Sign in to Volunteer at ATC</h2>
          <p>Your Google sign-in confirms your Signup and prevents duplicates.</p>
        </div>
      </div>
      <div id="gSignIn" style="display:inline-block;"></div>
      <div id="signinError" class="err"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" style="display:none">
    <header>
      <div class="brandRow">
        <img src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="Church Logo" class="logo" />
        <div>
          <h1>ATC Monthly Signups</h1>
          <p>Colossians 3:23‚Äì24 ‚Äî ‚ÄúWhatever you do, work at it with all your heart‚Ä¶ it is the Lord Christ you are serving.‚Äù</p>
        </div>
      </div>
    </header>

    <main>
      <!-- Submit form -->
      <section class="card" id="formCard">
        <form id="f" autocomplete="on">
          <!-- Service -->
<fieldset>
  <legend>Service</legend>
  <div class="grid-2">
    <div>
      <label for="month">Month<span class="req">*</span></label>
      <input type="month" id="month">
      <div class="muted" style="margin-top:6px">Pick a month; Sundays will appear below with roles.</div>
    </div>
  </div>
</fieldset>

<!-- Month Sundays + roles (auto-generated) -->
<section class="card" id="monthGridCard">
  <h2 style="margin-top:0;">Select Sundays & Roles</h2>
  <div id="monthGrid" class="monthGrid">
    <div class="muted">Select a month to load Sundays‚Ä¶</div>
  </div>
</section>

          <fieldset>
            <legend>Contact information</legend>
            <div class="grid-2">
              <div>
                <label for="first">First Name<span class="req">*</span></label>
                <input id="first" type="text" required minlength="4" pattern="[A-Za-z][A-Za-z\s\-']{3,}" placeholder="e.g., John">
              </div>
              <div>
                <label for="last">Last Name<span class="req">*</span></label>
                <input id="last" type="text" required minlength="4" pattern="[A-Za-z][A-Za-z\s\-']{3,}" placeholder="e.g., Doe">
              </div>
            </div>
            <div class="grid-2">
              <div>
                <label for="email">Email<span class="req">*</span></label>
                <input id="email" type="email" required placeholder="name@example.com">
              </div>
              <div>
                <label for="phone">Phone<span class="req">*</span></label>
                <input id="phone" type="text" inputmode="tel" required placeholder="(###) ###-####">
              </div>
            </div>
            <div>
              <label for="notes">Comments / Notes</label>
              <textarea id="notes" placeholder="Any preferences or availability details‚Ä¶"></textarea>
            </div>
          </fieldset>

          <fieldset>
            <legend>Choose your team(s)<span class="req">*</span></legend>
            <div id="roles" class="teams"><div class="muted">Pick a month/date to load roles‚Ä¶</div></div>
          </fieldset>

          <div class="actions">
            <button class="primary" type="submit" id="submit">Submit</button>
            <button class="secondary" type="reset">Clear</button>
          </div>
          <div id="ok" class="msg success">Thank you! Your signup was recorded.</div>
          <div id="err" class="msg error">Sorry, something went wrong.</div>
        </form>
      </section>

      <!-- Live SIGNUP Status  -->
      <section class="card" id="rosterCard">
        <h2 style="margin-top:0;">LIVE SIGNUP STATUS</h2>
        <div class="tableWrap">
          <table class="roster">
            <thead><tr><th>Team</th><th>Volunteers</th></tr></thead>
            <tbody id="roster"><tr><td colspan="2" class="muted">Select a date.</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- Admin metrics (only if admin) -->
      <section class="card" id="adminCard" style="display:none">
        <h2 style="margin-top:0">Admin ‚Äî Activity Metrics</h2>
        <div class="tableWrap">
          <table class="metrics">
            <thead><tr><th>Email</th><th>Views</th><th>Submits</th></tr></thead>
            <tbody id="metrics"><tr><td colspan="3" class="muted">No data.</td></tr></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer></footer>
  </div>

  <script>
    // === Config (use your deployed Web App URL) ===
    const GOOGLE_CLIENT_ID = "180743986209-prt051o1bp6namb57ababodokq0eadfv.apps.googleusercontent.com";
    const ADMIN_EMAILS = ["atc.noting@gmail.com","chakdom@gmail.com"];
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzeMYO7V9OX7iBFzuRtfbMXrk9CzP0xArxeB0hOOdXZjdklGtOBlTjeLpYDFOrGQsHk/exec";

    // === State ===
    let ID_TOKEN = '';
    let PROFILE  = null;

    function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const s = document.createElement('script');
      const timedOut = setTimeout(() => {
        cleanup();
        reject(new Error('JSONP timeout'));
      }, 12000);
      function cleanup() {
        clearTimeout(timedOut);
        try { delete window[cb]; } catch(_) { window[cb] = undefined; }
        s.remove();
      }
      window[cb] = (data) => { cleanup(); resolve(data); };
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
      document.head.appendChild(s);
    });
  }

    // === GIS init ===
    function initGIS(){
      const overlay = document.getElementById('signinOverlay');
      overlay.style.display = 'flex';
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp) => {
          try{
            if(!resp || !resp.credential) throw new Error('No credential returned.');
            ID_TOKEN = resp.credential;
            localStorage.setItem('atc_id_token', ID_TOKEN);
            localStorage.setItem('atc_id_token_time', Date.now().toString());
            overlay.style.display='none';
            document.getElementById('app').style.display='block';
            initAfterSignIn();
          }catch(e){
            const el = document.getElementById('signinError');
            el.textContent = e.message || 'Sign-in failed. Please try again.';
            el.style.display = 'block';
          }
        },
        auto_select: false,
        ux_mode: 'popup'
      });
      google.accounts.id.renderButton(
        document.getElementById('gSignIn'),
        { theme: "outline", size: "large", text: "signin_with", shape: "pill" }
      );
    }

    // === Helpers ===
    const $ = (id)=>document.getElementById(id);

    function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const to = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, 12000);
    function cleanup(){ clearTimeout(to); try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); }
    window[cb] = (data) => { cleanup(); resolve(data); };
    s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.head.appendChild(s);
  });
}
    // Store per-date roles/remaining in memory so we don't refetch on every tiny change
const MonthState = {
  dates: [],            // array of ISO 'yyyy-MM-dd'
  byDate: {},           // { date: { roles:[{role,limit}], remaining:{role:n|null} } }
};

// Render the grid of Sunday cards
function renderMonthGrid(cal){
  const grid = $('monthGrid');
  grid.innerHTML = '';

  if (!cal || !cal.length){
    grid.innerHTML = '<div class="muted">No Sundays found for this month.</div>';
    return;
  }

  MonthState.dates = cal.map(d => d.ServiceDate);
  MonthState.byDate = {}; // reset

  for (const d of cal){
    const id = `day_${d.ServiceDate}`;
    grid.insertAdjacentHTML('beforeend', `
      <div class="sundayCard" id="${id}">
        <div class="sundayHead">
          <div><strong>${d.ServiceDate}</strong> <span class="badge">${d.Title || 'Service'}</span></div>
        </div>
        <div class="roleList" data-date="${d.ServiceDate}">
          <div class="muted">Loading roles‚Ä¶</div>
        </div>
        <div class="muted" style="margin-top:8px">Current Signups:</div>
        <div class="roleList rosterList" data-roster="${d.ServiceDate}">
          <div class="muted">Loading roster‚Ä¶</div>
        </div>
      </div>
    `);
  }

  // Load roles & roster for each date
  for (const d of cal){
    loadRolesForDate(d.ServiceDate);
    loadRosterForDate(d.ServiceDate);
  }
}

// Load roles + remaining for a specific date and render into that card
async function loadRolesForDate(dateISO){
  try{
    const month = $('month').value;
    const url = `${ENDPOINT}?mode=roles&month=${encodeURIComponent(month)}&date=${encodeURIComponent(dateISO)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
    const { roles } = await jsonp(url);
    MonthState.byDate[dateISO] = { roles };

    const list = document.querySelector(`.roleList[data-date="${dateISO}"]`);
    if (!list) return;

    if (!roles || !roles.length){
      list.innerHTML = '<div class="muted">No roles available for this date.</div>';
      return;
    }

    // Build checkboxes; no counts displayed
    list.innerHTML = '';
    roles.forEach(r=>{
      list.insertAdjacentHTML('beforeend', `
        <label class="roleItem">
          <input type="checkbox" name="role-${dateISO}" value="${r.role.replace(/"/g,'&quot;')}">
          <span>${r.role}</span>
        </label>
      `);
    });
  }catch(e){
    const list = document.querySelector(`.roleList[data-date="${dateISO}"]`);
    if (list) list.innerHTML = `<div class="muted">Failed to load roles.</div>`;
    console.error('loadRolesForDate error:', e);
  }
}
async function loadRosterForDate(dateISO){
  try{
    const month = $('month').value;
    const url = `${ENDPOINT}?mode=roster&month=${encodeURIComponent(month)}&date=${encodeURIComponent(dateISO)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
    const roster = await jsonp(url); // { role: [names] }
    const area = document.querySelector(`.rosterList[data-roster="${dateISO}"]`);
    if (!area) return;

    const roles = Object.keys(roster || {});
    if (!roles.length) {
      area.innerHTML = '<div class="muted">No signups yet.</div>';
      return;
    }

    // table-like list (role ‚Üí names chips)
    const rows = roles.map(role=>{
      const names = (roster[role]||[]).map(n=>`<span class="chip">${n}</span>`).join(' ');
      return `<div class="roleItem"><div class="roleLeft" style="min-width:160px">${role}</div><div>${names || '<span class="muted">‚Äî</span>'}</div></div>`;
    }).join('');
    area.innerHTML = rows;

  }catch(e){
    const area = document.querySelector(`.rosterList[data-roster="${dateISO}"]`);
    if (area) area.innerHTML = '<div class="muted">Failed to load roster.</div>';
    console.error('loadRosterForDate error:', e);
  }
}

// Gather all selected roles across all selected Sundays for one submit
function collectMonthSelections(){
  const picks = []; // [{ date:'yyyy-MM-dd', roles:[...] }]
  for (const date of MonthState.dates){
    const selected = [...document.querySelectorAll(`input[name="role-${date}"]:checked`)].map(x=>x.value);
    if (selected.length) picks.push({ date, roles: selected });
  }
  return picks;
}


    async function loadDates(){
    const month = $('month').value;
    const $date = $('date');
    $date.innerHTML = '';

  try{
    const url = `${ENDPOINT}?mode=calendar&month=${encodeURIComponent(month)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
    const { cal, profile, isAdmin } = await jsonp(url);

    if (isAdmin) { $('adminCard').style.display = 'block'; loadMetrics(); }

    if (!cal || !cal.length) {
      $date.insertAdjacentHTML('beforeend','<option value="">No dates</option>');
      return;
    }
    cal.forEach(d => {
      $date.insertAdjacentHTML('beforeend',
        `<option value="${d.ServiceDate}">${d.ServiceDate} ‚Äî ${d.Title || 'Service'}</option>`);
    });

    // Immediately refresh roles/roster for the first date
    refreshRolesAndRoster();

  } catch(e){
    console.error('loadDates error:', e);
    const el = $('signinError');
    el.textContent = (e && e.message) ? e.message : 'Failed to load dates.';
    el.style.display = 'block';
  }
}
    function setDefaultMonth(){
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      $('month').value = y + '-' + m;
    }

    function phoneMask(el){
      let v = el.value.replace(/\D/g,'').slice(0,10);
      const p=[]; if(v.length>0) p.push('(' + v.substring(0,Math.min(3,v.length)));
      if(v.length>=4) p[0]+=') ' + v.substring(3,Math.min(6,v.length));
      if(v.length>=7) p[0]+='-' + v.substring(6,10);
      el.value = p[0] || v;
    }

    async function loadMetrics(){
  try{
    const url = `${ENDPOINT}?mode=metrics&id_token=${encodeURIComponent(ID_TOKEN)}`;
    const rows = await jsonp(url);
    const tb = $('metrics'); tb.innerHTML='';
    if(!rows || !rows.length){ tb.innerHTML='<tr><td colspan="3" class="muted">No data.</td></tr>'; return; }
    rows.forEach(r=>{
      tb.insertAdjacentHTML('beforeend','<tr><td>'+r.email+'</td><td>'+r.views+'</td><td>'+r.submits+'</td></tr>');
    });
  }catch(_){}
}

    async function loadDates(){
  const $month = $('month');
  if (!$month.value) setDefaultMonth();
  const month = $month.value;

  try{
    const url = `${ENDPOINT}?mode=calendar&month=${encodeURIComponent(month)}&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`;
    const res = await jsonp(url);
    console.log('[loadDates] calendar ‚Üí', res);

    const cal = Array.isArray(res?.cal) ? res.cal : [];
    if (!cal.length){
      $('monthGrid').innerHTML = '<div class="muted">No Sundays found for this month.</div>';
      return;
    }

    renderMonthGrid(cal);  // builds empty cards, then loads per-date roles

  }catch(e){
    console.error('loadDates error:', e);
    const el = $('signinError');
    el.textContent = (e && e.message) ? e.message : 'Failed to load Sundays.';
    el.style.display = 'block';
  }
}

    async function initAfterSignIn(){

  try {
  jsonp(`${ENDPOINT}?mode=view_ping&id_token=${encodeURIComponent(ID_TOKEN||'TEST')}`).catch(()=>{});
} catch(_) {}

  $('app').style.display='block';
  setDefaultMonth();
  $('phone').addEventListener('input', ()=> phoneMask($('phone')));
  $('month').addEventListener('change', loadDates);
  $('date').addEventListener('change', refreshRolesAndRoster);
  await loadDates();

  $('f').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const month = $('month').value;
  const first = $('first').value.trim(), last = $('last').value.trim();
  const email = $('email').value.trim(), phone = $('phone').value.trim();
  const comments = $('notes').value.trim();
  const re = /^[A-Za-z][A-Za-z\s\-']{3,}$/;

  const selections = collectMonthSelections(); // [{date, roles:[]}]
  if(!month || !re.test(first) || !re.test(last) || !email || !phone || !selections.length){
    $('err').style.display='block';
    $('err').textContent='Please fill all fields and pick at least one date & role.';
    return;
  }

  $('submit').disabled = true; $('ok').style.display='none'; $('err').style.display='none';

  try{
    const url = `${ENDPOINT}?mode=submit_month_get`
      + `&id_token=${encodeURIComponent(ID_TOKEN)}`
      + `&month=${encodeURIComponent(month)}`
      + `&firstName=${encodeURIComponent(first)}`
      + `&lastName=${encodeURIComponent(last)}`
      + `&email=${encodeURIComponent(email)}`
      + `&phone=${encodeURIComponent(phone)}`
      + `&comments=${encodeURIComponent(comments)}`
      + `&selections=${encodeURIComponent(JSON.stringify(selections))}`;

    const out = await jsonp(url);

    // >>> SUCCESS BRANCH (replaced) <<<
    if (out && out.ok) {
      const ok = $('ok');
      ok.textContent = 'Thank you! Your signup was recorded. A confirmation email has been sent.';
      ok.style.display = 'block';

      $('f').reset();
      setDefaultMonth();
      await loadDates();

      if ($('adminCard') && $('adminCard').style.display !== 'none') {
        loadMetrics();
      }
      try { ok.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) {}
    } else {
      throw new Error((out && out.error) || 'Submission failed.');
    }

  } catch(err){
    $('err').textContent = (err && err.message) ? err.message : 'Submission failed.';
    $('err').style.display='block';
  } finally{
    $('submit').disabled = false;
  }
});
}
    // Boot
    // Boot logic with localStorage sign-in persistence
window.addEventListener('load', async () => {
  const cachedToken = localStorage.getItem('atc_id_token');
  const cachedTime  = parseInt(localStorage.getItem('atc_id_token_time') || '0', 10);
  const now = Date.now();

  // If cached token is < 1 hour old, reuse it
  if (cachedToken && (now - cachedTime < 3600 * 1000)) {
    ID_TOKEN = cachedToken;
    document.getElementById('signinOverlay').style.display='none';
    document.getElementById('app').style.display='block';
    console.log('‚úÖ Reusing existing sign-in token.');
    initAfterSignIn();
  } else {
    console.log('üïì Need to sign in again.');
    initGIS();
  }
});

  </script>
</body>
</html>
