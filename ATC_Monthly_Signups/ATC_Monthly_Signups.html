<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ATC Monthly Signups</title>
<style>
  :root{--max:980px;--pad:18px;--radius:16px;--ink:#1f2937;--muted:#6b7280;--bg:#f7f7fb;--card:#fff;--accent:#2b6cb0;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:#222;color:#fff;padding:24px var(--pad);text-align:center}
  header .logo{position:absolute;left:18px;top:18px;height:56px;width:56px;border-radius:12px;background:#fff;padding:8px;box-shadow:0 6px 20px rgba(0,0,0,.2)}
  header h1{margin:0 0 6px;font-size:clamp(1.4rem,3.4vw,2.2rem)}
  header p{margin:0;opacity:.95;font-style:italic}
  main{max-width:var(--max);margin:20px auto;padding:0 var(--pad);display:grid;gap:16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px}
  fieldset{border:0;margin:0 0 12px;padding:0}
  legend{font-weight:800;margin-bottom:10px}
  label{font-weight:600;display:block;margin-bottom:6px}
  input[type="month"],input[type="text"],input[type="email"],textarea,select{width:100%;padding:12px 14px;border:1px solid #d9dbe3;border-radius:10px;background:#fff;font-size:1rem}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:800px){.grid-2{grid-template-columns:1fr}}
  .teams{display:grid;grid-template-columns:1fr 1fr;gap:10px 16px}
  @media (max-width:800px){.teams{grid-template-columns:1fr}}
  .team{display:flex;gap:10px;align-items:center;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  button{border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  .primary{background:var(--accent);color:#fff}
  .secondary{background:#eef2f7}
  .msg{display:none;margin-top:12px;padding:12px 14px;border-radius:10px}
  .ok{background:#e6fffa;border:1px solid #b2f5ea;color:#065f46}
  .err{background:#fff5f5;border:1px solid #fecaca;color:#7f1d1d}
  .muted{color:var(--muted)}
  .tableWrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e5e7eb;text-align:left;padding:10px 6px;vertical-align:top}
  .chip{display:inline-block;margin:4px 6px 0 0;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px}
</style>
</head>
<body>
  <header>
    <img class="logo" src="https://raw.githubusercontent.com/atc-code/ATC_Signups/main/images/ATC_Logo1.png" alt="ATC"/>
    <h1>ATC Monthly Signups</h1>
    <p>Colossians 3:23–24 — “Whatever you do, work at it with all your heart… it is the Lord Christ you are serving.”</p>
  </header>

  <main>
    <section class="card">
      <form id="f">
        <fieldset>
          <legend style="font-size:1.15rem">Service Month</legend>
          <div class="grid-2">
            <div>
              <label for="month">Month *</label>
              <input type="month" id="month">
            </div>
            <div>
              <label>Available Roles (auto-hides if full)</label>
              <div id="roles" class="teams"><div class="muted">Select a month to load roles…</div></div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Contact Information</legend>
          <div class="grid-2">
            <div>
              <label for="first">First Name *</label>
              <input id="first" type="text" required minlength="4" placeholder="e.g., John">
            </div>
            <div>
              <label for="last">Last Name *</label>
              <input id="last" type="text" required minlength="4" placeholder="e.g., Doe">
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="email">Email *</label>
              <input id="email" type="email" required placeholder="name@example.com">
            </div>
            <div>
              <label for="phone">Phone *</label>
              <input id="phone" type="text" required placeholder="(###) ###-####">
            </div>
          </div>
          <div>
            <label for="notes">Comments / Notes</label>
            <textarea id="notes" placeholder="Any preferences or availability details…"></textarea>
          </div>
        </fieldset>

        <div class="actions">
          <button class="primary" type="submit" id="submit">Submit</button>
          <button class="secondary" type="reset">Clear</button>
        </div>
        <div id="ok" class="msg ok">Thank you! Your signup was recorded. A confirmation email has been sent.</div>
        <div id="err" class="msg err">Sorry, something went wrong.</div>
      </form>
    </section>

    <section class="card" id="rosterCard">
      <h2 style="margin-top:0">Current Signups</h2>
      <div class="tableWrap">
        <table>
          <thead><tr><th>Role</th><th>Volunteers</th></tr></thead>
          <tbody id="roster"><tr><td colspan="2" class="muted">No signups yet.</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
  // ====== CONFIG ======
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbxm8ojZW3cMZS_CWtJo-CdLY5Ph2zm3d7pooGWovtlxYkqrNaj4ih_ru5bhrEoCgL7k/exec";
  

  // ====== Helpers ======
  const $ = id => document.getElementById(id);
  function saveMonthLocal(m){ try{ localStorage.setItem('atc_month', m);}catch(_){ } }
  function loadMonthLocal(){ try{ return localStorage.getItem('atc_month')||'';}catch(_){ return '';} }
  function nowMonth(){ const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
  function phoneMask(v){ return v.replace(/\D/g,'').slice(0,10).replace(/^(\d{0,3})(\d{0,3})(\d{0,4}).*$/, (m,a,b,c)=> (a? '('+a+(b?') '+b:'')+(c?'-'+c:''):'') ); }

  // JSONP
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cb_'+Math.random().toString(36).slice(2);
      window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
      const s = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = () => { delete window[cb]; reject(new Error('Network error')); };
      document.head.appendChild(s);
    });
  }

  // ====== UI render ======
  function renderRoles(roles, remaining){
    const wrap = $('roles'); wrap.innerHTML='';
    if (!roles || !roles.length){ wrap.innerHTML = '<div class="muted">No roles configured.</div>'; return; }
    roles.forEach(r=>{
      const left = remaining.hasOwnProperty(r.role) ? remaining[r.role] : null;
      if (left !== null && left <= 0) return; // hide when full
      const id = 'role_'+r.role.replace(/\W+/g,'_');
      wrap.insertAdjacentHTML('beforeend',
        `<label class="team"><input type="checkbox" id="${id}" name="role" value="${r.role}"> ${r.role}</label>`);
    });
    if (!wrap.innerHTML) wrap.innerHTML = '<div class="muted">All roles are currently full.</div>';
  }

  function renderRoster(roster){
    const tb = $('roster'); tb.innerHTML='';
    const roles = Object.keys(roster||{});
    if (!roles.length){ tb.innerHTML = '<tr><td colspan="2" class="muted">No signups yet.</td></tr>'; return; }
    roles.forEach(role=>{
      const names = roster[role]||[];
      if (!names.length) return;
      tb.insertAdjacentHTML('beforeend',
        `<tr><td>${role}</td><td>${names.map(n=>`<span class="chip">${n}</span>`).join(' ')}</td></tr>`);
    });
  }

  // ====== Data loaders ======
  async function refreshRolesAndRoster(){
    const month = $('month').value;
    if (!month) return;

    // roles + remaining
    try{
      const r1 = await jsonp(`${ENDPOINT}?mode=roles_remaining&month=${encodeURIComponent(month)}`);
      if (r1 && r1.ok) renderRoles(r1.roles, r1.remaining);
      else $('roles').innerHTML = '<div class="muted">Failed to load roles.</div>';
    }catch(_){
      $('roles').innerHTML = '<div class="muted">Failed to load roles.</div>';
    }

    // roster
    try{
      const r2 = await jsonp(`${ENDPOINT}?mode=roster_month&month=${encodeURIComponent(month)}`);
      if (r2 && r2.ok) renderRoster(r2.roster);
      else renderRoster({});
    }catch(_){ renderRoster({}); }
  }

  async function loadCalendarFor(month){
    // Optional: if you keep Calendar sheet and want to use it later
    try{
      await jsonp(`${ENDPOINT}?mode=calendar&month=${encodeURIComponent(month)}`);
    }catch(_){}
  }

  // ====== Submit ======
  $('phone').addEventListener('input', e=> e.target.value = phoneMask(e.target.value));

  $('f').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const month = $('month').value;
    const first = $('first').value.trim();
    const last  = $('last').value.trim();
    const email = $('email').value.trim();
    const phone = $('phone').value.trim();
    const notes = $('notes').value.trim();
    const roles = [...document.querySelectorAll('input[name="role"]:checked')].map(x=>x.value);

    if (!month || !first || first.length<4 || !last || last.length<4 || !email || !phone || !roles.length){
      $('err').textContent = 'Please complete all required fields.'; $('err').style.display='block'; return;
    }

    $('submit').disabled = true; $('ok').style.display='none'; $('err').style.display='none';

    try{
      const url = `${ENDPOINT}?mode=submit_get`
        + `&month=${encodeURIComponent(month)}`
        + `&firstName=${encodeURIComponent(first)}`
        + `&lastName=${encodeURIComponent(last)}`
        + `&email=${encodeURIComponent(email)}`
        + `&phone=${encodeURIComponent(phone)}`
        + `&comments=${encodeURIComponent(notes)}`
        + `&roles=${encodeURIComponent(roles.join(','))}`;

      const out = await jsonp(url);
      if (out && out.ok){
        $('ok').style.display='block';
        $('f').reset();
        saveMonthLocal(month); // keep selection across refresh
        await refreshRolesAndRoster(); // reflect immediately
      } else {
        throw new Error((out && out.error) || 'Submission failed.');
      }
    }catch(err){
      $('err').textContent = err.message || 'Submission failed.';
      $('err').style.display='block';
    }finally{
      $('submit').disabled = false;
    }
  });

  // ====== Boot ======
  window.addEventListener('load', async ()=>{
    // default to current month; if user picked something before, keep it
    const remembered = loadMonthLocal();
    $('month').value = remembered || nowMonth();
    $('month').addEventListener('change', async ()=>{
      saveMonthLocal($('month').value);
      await refreshRolesAndRoster();
    });
    await refreshRolesAndRoster();
  });
</script>
</body>
</html>
